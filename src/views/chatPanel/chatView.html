<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeminiBot Chat</title>
    <style>
        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            color: var(--vscode-foreground);
            padding: 0;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            max-width: 85%;
            word-wrap: break-word;
        }

        .user-message {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            align-self: flex-end;
            margin-left: auto;
        }

        .model-message {
            background-color: var(--vscode-editor-inactiveSelectionBackground);
            color: var(--vscode-editor-foreground);
        }

        pre {
            background-color: var(--vscode-editor-background);
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 8px 0;
        }

        code {
            font-family: var(--vscode-editor-font-family);
            font-size: var(--vscode-editor-font-size);
        }

        #input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid var(--vscode-panel-border);
        }

        #message-input {
            flex: 1;
            resize: none;
            padding: 8px;
            border: 1px solid var(--vscode-input-border);
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            font-family: var(--vscode-font-family);
            border-radius: 4px;
            min-height: 40px;
            max-height: 120px;
        }

        #send-button {
            margin-left: 8px;
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 0 12px;
            cursor: pointer;
            border-radius: 4px;
        }

        #send-button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .api-key-warning {
            padding: 20px;
            text-align: center;
        }

        .api-key-button {
            margin-top: 10px;
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
        }

        .loading {
            display: flex;
            align-items: center;
            margin: 10px 0;
            color: var(--vscode-descriptionForeground);
        }

        .loading-dots {
            display: flex;
            margin-left: 8px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            margin: 0 4px;
            background-color: var(--vscode-descriptionForeground);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1.0);
            }
        }
    </style>
</head>

<body>
    <div id="chat-container">
        <div id="api-key-container" class="api-key-warning" style="display: none;">
            <p>Please set your Gemini API key to use the chat feature.</p>
            <button class="api-key-button" id="set-api-key">Set API Key</button>
        </div>

        <div id="chat-interface" style="display: none;">
            <div id="messages"></div>
            <div id="input-container">
                <textarea id="message-input" placeholder="Type a message..." rows="1"
                    aria-label="Message input"></textarea>
                <button id="send-button">Send</button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            // Get VS Code API
            const vscode = acquireVsCodeApi();

            // Elements
            const messagesContainer = document.getElementById('messages');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const apiKeyContainer = document.getElementById('api-key-container');
            const chatInterface = document.getElementById('chat-interface');
            const setApiKeyButton = document.getElementById('set-api-key');

            let isLoading = false;

            // Auto-resize textarea
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = messageInput.scrollHeight + 'px';
            });

            // Send message when Enter key is pressed (but not with Shift+Enter)
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Send message when button is clicked
            sendButton.addEventListener('click', sendMessage);

            // Set API key button
            setApiKeyButton.addEventListener('click', () => {
                vscode.postMessage({ command: 'setApiKey' });
            });

            // Check if API key is set
            vscode.postMessage({ command: 'checkApiKey' });

            // Handle messages from extension
            window.addEventListener('message', (event) => {
                const message = event.data;

                switch (message.command) {
                    case 'apiKeyStatus':
                        if (message.exists) {
                            apiKeyContainer.style.display = 'none';
                            chatInterface.style.display = 'flex';
                            chatInterface.style.flexDirection = 'column';
                            chatInterface.style.height = '100%';
                        } else {
                            apiKeyContainer.style.display = 'block';
                            chatInterface.style.display = 'none';
                        }
                        break;

                    case 'receiveMessage':
                        addMessage(message.message, message.role);
                        break;

                    case 'startLoading':
                        showLoading();
                        break;

                    case 'stopLoading':
                        hideLoading();
                        break;

                    case 'error':
                        showError(message.message);
                        hideLoading();
                        break;

                    case 'clearChat':
                        messagesContainer.innerHTML = '';
                        break;
                }
            });

            function sendMessage() {
                const text = messageInput.value.trim();
                if (text && !isLoading) {
                    // Add user message to UI
                    addMessage(text, 'user');

                    // Send to extension
                    vscode.postMessage({
                        command: 'sendMessage',
                        text
                    });

                    // Clear input
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                }
            }

            function addMessage(text, role) {
                // Create message element
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}-message`;

                // Format text with markdown-style code blocks
                const formattedText = formatMessageText(text);
                messageDiv.innerHTML = formattedText;

                // Add to container
                messagesContainer.appendChild(messageDiv);

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function formatMessageText(text) {
                // Replace code blocks with formatted HTML
                return text.replace(/```(\w*)\n([\s\S]*?)```/g, (_, language, code) => {
                    return `<pre><code class="language-${language}">${escapeHtml(code)}</code></pre>`;
                }).replace(/\n/g, '<br>');
            }

            function escapeHtml(text) {
                return text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            function showLoading() {
                isLoading = true;

                // Create loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading';
                loadingDiv.id = 'loading-indicator';
                loadingDiv.innerHTML = `
          Gemini is thinking
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        `;

                messagesContainer.appendChild(loadingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function hideLoading() {
                isLoading = false;
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
            }

            function showError(errorMessage) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message model-message';
                errorDiv.innerHTML = `<span style="color: var(--vscode-errorForeground);">Error: ${errorMessage}</span>`;
                messagesContainer.appendChild(errorDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        })();
    </script>
</body>

</html>